'use client'

import React, { useState, useEffect } from 'react'
import { useSearchParams } from 'next/navigation'
import CourseTopBar from './components/CourseTopBar'
import CourseDetails from '../course-interface/components/CourseDetails'
import CourseMembers from '../course-interface/components/CourseMembers'
import PostsList from './components/PostsList'
import CourseFiles from '../course-interface/components/CourseFiles'

interface CourseData {
  id: string
  title: string
  description: string
  instructor: string
  startDate: string
  endDate: string
  studentsCount: number
  status: 'active' | 'upcoming' | 'completed'
  objectives?: string[]
  requirements?: string[]
  duration?: string
  level?: string
  language?: string
  location?: string
  category?: string
}

interface Member {
  id: string
  name: string
  email: string
  avatar?: string
  role: 'admin' | 'teacher' | 'student'
  joinDate: string
  lastActive?: string
  isOnline?: boolean
}

interface UserData {
  name: string
  avatar?: string
  role: 'teacher' | 'student'
}

export default function CourseInterface() {
  const searchParams = useSearchParams()
  const courseId = searchParams.get('courseId')
  const courseName = searchParams.get('courseName')

  const [courseData, setCourseData] = useState<CourseData>({
    id: courseId || '1',
    title: courseName ? decodeURIComponent(courseName) : 'Ø¯ÙˆØ±Ø© ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…',
    description: 'ØªØ¹Ù„Ù… ØªÙ„Ø§ÙˆØ© Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… Ø¨Ø£Ø­ÙƒØ§Ù… Ø§Ù„ØªØ¬ÙˆÙŠØ¯ Ø§Ù„ØµØ­ÙŠØ­Ø© Ù…Ø¹ Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„Ù…ØªØ®ØµØµÙŠÙ† ÙÙŠ Ø¹Ù„ÙˆÙ… Ø§Ù„Ù‚Ø±Ø¢Ù†',
    instructor: 'Ø¯. Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø­Ø§ÙØ¸',
    startDate: '2024-01-15',
    endDate: '2024-03-15',
    studentsCount: 25,
    status: 'active',
    objectives: [
      'ØªØ¹Ù„Ù… Ø£Ø­ÙƒØ§Ù… Ø§Ù„ØªØ¬ÙˆÙŠØ¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©',
      'Ø¥ØªÙ‚Ø§Ù† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©',
      'ÙÙ‡Ù… Ù…Ø®Ø§Ø±Ø¬ Ø§Ù„Ø­Ø±ÙˆÙ ÙˆØµÙØ§ØªÙ‡Ø§',
      'ØªØ·Ø¨ÙŠÙ‚ Ø£Ø­ÙƒØ§Ù… Ø§Ù„ÙˆÙ‚Ù ÙˆØ§Ù„Ø§Ø¨ØªØ¯Ø§Ø¡'
    ],
    requirements: [
      'Ù…Ø¹Ø±ÙØ© Ø£Ø³Ø§Ø³ÙŠØ© Ø¨Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
      'Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø­Ø¶ÙˆØ± Ø§Ù„Ø¬Ù„Ø³Ø§Øª',
      'Ø£Ø¯Ø§Ø¡ Ø§Ù„ØªÙ…Ø§Ø±ÙŠÙ† Ø§Ù„Ø¹Ù…Ù„ÙŠØ©'
    ],
    duration: '8 Ø£Ø³Ø§Ø¨ÙŠØ¹',
    level: 'Ù…Ø¨ØªØ¯Ø¦',
    language: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
    location: 'Ø¹Ø¨Ø± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª',
    category: 'Ø¹Ù„ÙˆÙ… Ø´Ø±Ø¹ÙŠØ©'
  })

  // Update course data when URL parameters change
  useEffect(() => {
    if (courseId && courseName) {
      setCourseData(prev => ({
        ...prev,
        id: courseId,
        title: decodeURIComponent(courseName)
      }))
      console.log('ğŸ“š Course interface loaded for:', {
        courseId,
        courseName: decodeURIComponent(courseName)
      })
    }
  }, [courseId, courseName])

  const [members, setMembers] = useState<Member[]>([
    {
      id: '1',
      name: 'Ø¯. Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¹Ù„ÙŠ',
      email: 'admin@example.com',
      role: 'admin',
      joinDate: '2024-01-01',
      lastActive: 'Ù…Ù†Ø° Ø³Ø§Ø¹Ø©',
      isOnline: true
    },
    {
      id: '2',
      name: 'Ø¯. Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø­Ø§ÙØ¸',
      email: 'teacher@example.com',
      role: 'teacher',
      joinDate: '2024-01-10',
      lastActive: 'Ù…Ù†Ø° 30 Ø¯Ù‚ÙŠÙ‚Ø©',
      isOnline: true
    },
    {
      id: '3',
      name: 'ÙØ§Ø·Ù…Ø© Ø£Ø­Ù…Ø¯',
      email: 'student1@example.com',
      role: 'student',
      joinDate: '2024-01-15',
      lastActive: 'Ù…Ù†Ø° 5 Ø¯Ù‚Ø§Ø¦Ù‚',
      isOnline: true
    }
  ])

  const [userData, setUserData] = useState<UserData>({
    name: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯',
    avatar: '',
    role: 'teacher'
  })

  const [loading, setLoading] = useState(true)
  const [activeSection, setActiveSection] = useState<'details' | 'members'>('details')
  const [activeTab, setActiveTab] = useState<'announcements' | 'files'>('announcements')
  const [isSessionActive, setIsSessionActive] = useState(false)

  useEffect(() => {
    // Simulate loading course and user data
    const loadData = async () => {
      try {
        // Here you would fetch actual data from your API
        // const courseResponse = await fetch(`/api/courses/${courseId}`)
        // const userResponse = await fetch('/api/user/profile')

        // For now, we'll use mock data
        setTimeout(() => {
          setLoading(false)
        }, 1000)
      } catch (error) {
        console.error('Error loading data:', error)
        setLoading(false)
      }
    }

    loadData()
  }, [])

  const handleStartSession = () => {
    setIsSessionActive(!isSessionActive)
  }

  const handleFileUpload = (files: FileList) => {
    console.log('Files uploaded:', files)
  }

  if (loading) {
    return (
      <div className="min-h-screen bg-[#1f1f1f] flex items-center justify-center pt-16">
        <div className="text-center space-y-4">
          <div className="w-12 h-12 bg-primary/20 rounded-lg mx-auto flex items-center justify-center">
            <div className="w-6 h-6 border-3 border-primary border-t-transparent rounded-full animate-spin"></div>
          </div>
          <h2 className="text-lg font-semibold text-white">
            Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆØ±Ø©...
          </h2>
          <p className="text-sm text-gray-400">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p>
        </div>
      </div>
    )
  }

  const renderMainContent = () => {
    if (activeTab === 'files') {
      return (
        <CourseFiles
          userRole={userData.role}
          onUpload={handleFileUpload}
        />
      )
    }

    return (
      <PostsList
        courseId={courseData.id}
        userRole={userData.role}
        userName={userData.name}
        userAvatar={userData.avatar}
      />
    )
  }

  const renderSidebarContent = () => {
    if (activeSection === 'members') {
      return <CourseMembers courseId={courseData.id} />
    }

    return <CourseDetails course={courseData} />
  }

  return (
    <div className="min-h-screen bg-gray-50 dark:bg-slate-950 pt-20" dir="rtl">
      <div className="flex h-[calc(100vh-5rem)] gap-4 px-4">
        {/* Right Sidebar - Course Info & Details */}
        <div className="w-96 bg-white dark:bg-slate-900 rounded-lg border border-gray-200 dark:border-slate-700 overflow-y-auto">
          <div className="p-4">
            {/* Course Header */}
            <div className="mb-4 pb-4 border-b border-gray-200 dark:border-slate-700">
              <h1 className="text-xl font-bold text-gray-900 dark:text-slate-50 mb-2">{courseData.title}</h1>
              <p className="text-sm text-gray-600 dark:text-slate-400">{courseData.instructor}</p>
            </div>

            {/* Navigation Tabs */}
            <div className="flex gap-2 mb-4">
              <button
                onClick={() => setActiveSection('details')}
                className={`flex-1 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                  activeSection === 'details'
                    ? 'bg-primary text-white'
                    : 'bg-gray-100 dark:bg-slate-800 text-gray-700 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-700'
                }`}
              >
                ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³
              </button>
              <button
                onClick={() => setActiveSection('members')}
                className={`flex-1 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                  activeSection === 'members'
                    ? 'bg-primary text-white'
                    : 'bg-gray-100 dark:bg-slate-800 text-gray-700 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-700'
                }`}
              >
                Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
              </button>
            </div>

            {/* Content */}
            {renderSidebarContent()}
          </div>
        </div>

        {/* Main Content Area - Live Classes & Posts */}
        <div className="flex-1 flex flex-col bg-white dark:bg-slate-900 rounded-lg border border-gray-200 dark:border-slate-700 overflow-hidden">
          {/* Top Bar with Tabs & Action Buttons */}
          <CourseTopBar
            activeTab={activeTab}
            onTabChange={setActiveTab}
            onStartSession={handleStartSession}
            isSessionActive={isSessionActive}
            liveSessionsCount={isSessionActive ? 1 : 0}
            userRole={userData.role}
          />

          {/* Content */}
          <div className="flex-1 overflow-y-auto">
            <div className="p-6">
              {renderMainContent()}
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}
